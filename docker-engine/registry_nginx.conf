# Docker Registry 백엔드(upstream) 정의
upstream docker-registry {
    # docker-registry 컨테이너(또는 호스트)의 5000 포트로 요청 전달
    server my_registry:5000;
}

server {
    # HTTPS 443 포트에서 수신
    listen 443 ssl;

    # 서버 이름 (IP 또는 도메인)
    server_name 10.102.20.32;

    # SSL 인증서 파일 경로
    ssl_certificate /etc/nginx/conf.d/registry.crt;

    # SSL 개인키 파일 경로
    ssl_certificate_key /etc/nginx/conf.d/registry.key;

    # Docker 이미지 push 시 용량 제한 제거 (무제한)
    client_max_body_size 0;

    # chunked 전송 활성화 (대용량 이미지 업로드 안정화)
    chunked_transfer_encoding on;

    # Docker Registry API(v2) 경로 처리
    location /v2/ {

        # 구버전 Docker 클라이언트 요청 차단
        # (1.3, 1.4, 1.5 일부 버전 및 Go client)
        if ($http_user_agent ~ "^(docker\/1\.(3|4|5(?!\.[0-9]-dev))|Go ).*$" ) {
            return 404;
        }

        # HTTP Basic Authentication 활성화
        auth_basic "registry.localhost";

        # 인증 정보가 저장된 htpasswd 파일 경로
        auth_basic_user_file /etc/nginx/conf.d/htpasswd;

        # Docker Registry v2 API임을 명시하는 헤더 추가
        add_header 'Docker-Distribution-Api-Version' 'registry/2.0' always;

        # upstream으로 정의한 docker-registry로 요청 전달
        proxy_pass http://docker-registry;

        # 원본 Host 헤더 전달
        proxy_set_header Host $http_host;

        # 실제 클라이언트 IP 전달
        proxy_set_header X-Real-IP $remote_addr;

        # 프록시를 거친 전체 IP 체인 전달
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # 요청이 HTTPS였음을 백엔드에 전달
        proxy_set_header X-Forwarded-Proto $scheme;

        # 이미지 pull/push 시 긴 처리시간 허용 (초)
        proxy_read_timeout 900;
    }
}
