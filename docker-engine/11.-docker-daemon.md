# 11. Docker Daemon

## 1. docker의 구조

docker의 구조는 크게 두가지이다. (클라이언트의 docker(docker), 서버의 docker(dockerd))

CLI를 제공하는게 도커 클라이언트 이다.  `docker ~`로 시작하는 걸 쓰면 그게 도커 클라이언트를 쓰는것이다.
docker daemon은 /var/run/docker.sock을 이용한다.

## 2. docker 데몬 설정

### 2-1. docker 데몬제어 `-H`
`-H` 옵션은 도커 데몬의 API를 사용할 수 있는 방법을 추가한다.
추가하게 되면, RESTFUL API의 성격을 띄게 되며, 소켓을 지정하지 않으면, 도커 클라이언트는 더이상 사용할 수 없게 된다.

그러므로, 
```bash
dockerd -H unix:///var/run/docker.sock -H tcp://0.0.0.0:${port} --tls=false
```
`tls` 인증은 보안을 위해서라도, 항상 적용하는게 좋다.

### 2-2. docker daemon에 보안 적용 `--tlsverify`
도커를 설치하면 보안 연결이 안되어있다. 

1. 서버 측 파일 생성
   1. 인증서에 사용될 키를 생성
    **설명**  
   - CA(인증기관)에서 사용할 루트 개인키 생성  
   - `-aes256`: 키 파일 암호화  
   - `4096`: 4096비트 RSA 키  
   - 비밀번호는 이후 서명 과정에서 다시 필요함  
    ```bash
    ❯ openssl genrsa -aes256 -out ca-key-rootPw.pem 4096
    Enter PEM pass phrase:
    Verifying - Enter PEM pass phrase:
    ```
	

   2. 공용키를 생성
   **설명**  
   - 루트 개인키로 자체 서명 CA 인증서 생성  
   - `-x509`: CSR 없이 바로 인증서 생성  
   - `-days 10000`: 약 27년 유효  
   - 출력: `ca-key-public.pem` (CA 공개 인증서)
   ```bash
   ❯ openssl req -new -x509 -days 10000 -key ca-key-rootPw.pem -sha256 -out ca-key-public.pem
    Enter pass phrase for ca-key-rootPw.pem:
    You are about to be asked to enter information that will be incorporated
    into your certificate request.
    What you are about to enter is what is called a Distinguished Name or a DN.
    There are quite a few fields but you can leave some blank
    For some fields there will be a default value,
    If you enter '.', the field will be left blank.
    -----
    Country Name (2 letter code) [AU]:
    State or Province Name (full name) [Some-State]:
    Locality Name (eg, city) []:
    Organization Name (eg, company) [Internet Widgits Pty Ltd]:
    Organizational Unit Name (eg, section) []:
    Common Name (e.g. server FQDN or YOUR name) []:
    Email Address []:
   ```

   3. 서버 측에서 사용될 키를 생성
   **설명**  
   - 서버 전용 개인키 생성  
   - 추후 CSR 발급에 사용됨  
   ```bash
   openssl genrsa -out server-key.pem 4096
   ```

   4. 서버측에서 사용될 인증 요청서 파일을 생성
   **설명**  
   - 서버 인증서 발급용 CSR 생성  
   - `-subj` 로 입력값 자동 설정  
   ```bash
   openssl req -subj "/CN=192.168.64.3" -sha256 -new -key server-key.pem -out server.csr
   ```

   5. 접속에 사용될 IP주소를 extfile.cnf 파일로 저장
   **설명**  
   - SAN(Subject Alternative Name) 정의  
   - 인증서 검증 시 필수 항목으로, 서버가 해당 IP에서 TLS 인증 통과 가능  

   ```extfile.cnf
	subjectAltName = IP:192.168.64.3,IP:127.0.0.1
   ```

   6. 서버측의 인증서 파일을 생성
   **설명**  
   - CSR을 CA가 서명해 서버 인증서 발급  
   - `-CAcreateserial` : CA용 serial 파일 생성  
   - 출력: `server-cert.pem` (서버 인증서)
   ```bash
   	❯ openssl x509 -req -days 10000 -sha256 -in server.csr \
			-CA ca-key-public.pem -CAkey ca-key-rootPw.pem \
			-CAcreateserial -out server-cert.pem -extfile extfile.cnf
	Certificate request self-signature ok
	subject=CN = 192.168.64.3
	Enter pass phrase for ca-key-rootPw.pem:
   ```