# 9. 도커 이미지 생성

## 1. 도커 컨테이너 -> 이미지 생성

`docker commit $(OPTIONS) $(Container) $Repository[:tag]`

먼저 컨테이너 생성
`docker run -it --name commit_test ubuntu`
후, 파일을 생성
`echo test >> test.txt`

```bash
docker commit \
-a "ohkang94" \
-m "my first commit" \
commit_test \
commit_test:first
```

-a "ohkang94" : 작성자 메타데이터에 표기

그럼,

```bash
❯ docker images
REPOSITORY                             TAG                    IMAGE ID       CREATED          SIZE
commit_test                            first                  d2dc0412deb8   59 seconds ago   139MB
```

이렇게 생김.
그리고, 확인해보면, layer만 쌓여있는것을 확인함

```bash
❯ docker history commit_test:first
IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT
d2dc0412deb8   2 minutes ago   /bin/bash                                       16.4kB    my first commit
9cbed7541129   3 weeks ago     /bin/sh -c #(nop)  CMD ["/bin/bash"]            0B
<missing>      3 weeks ago     /bin/sh -c #(nop) ADD file:b7517e9b93ca90114…   110MB
<missing>      3 weeks ago     /bin/sh -c #(nop)  LABEL org.opencontainers.…   0B
<missing>      3 weeks ago     /bin/sh -c #(nop)  LABEL org.opencontainers.…   0B
<missing>      3 weeks ago     /bin/sh -c #(nop)  ARG LAUNCHPAD_BUILD_ARCH     0B
<missing>      3 weeks ago     /bin/sh -c #(nop)  ARG RELEASE                  0B
```

## 2. 도커 이미지 추출 및 로드

1. save / load

대상: 이미지

형식: tar 아카이브 (레이어 + 메타데이터 포함)

예시

```bash
# 저장

docker save -o commit_image.tar commit_test:first

# 복원

docker load -i commit_image.tar
```

장점: 이미지 태그, 메타데이터 유지됨

단점: 파일 크기가 큼

2. export / import

대상: 컨테이너
형식: 단일 tar 파일 (컨테이너의 파일시스템 스냅샷)
예시

```bash
# 컨테이너 export

docker export commit_test > container.tar

# import → 새 이미지 생성

docker import container.tar new_image:latest
```

차이점:
export는 레이어 정보가 사라지고 컨테이너의 현재 파일시스템만 저장됨

따라서 기존 이미지 히스토리(docker history)는 날아감

대신 파일 하나로 깔끔하게 옮기고 싶을 때 좋음

## 3. 이미지 배포

### 3.1. DockerHub에 배포

도커 로그인 후, CLI에
`docker login`

사이트에서 Repository 만들고,
태그 변경하고,

```bash
docker tag commit_test:first ohkang94/test:1.0.0
```

push

```bash
docker push ohkang94/test:1.0.0
```

### 3.2. 사설 Registry 배포

#### 생성

```bash
docker run -d --name my_registry \
-p 5000:5000 \
--restart=always \
registry:2.6
```

--restart는 종료되었을때 정책

#### Push

`docker push localhost:5000/ohkang94/test:1.0.0`

- context로 들어간가서, daemon.json을 찾아서,

```json
{
  // 혹은 IP입력
  "insecure-registries": ["localhost:5000"]
}
```

을 만들어서해야함

그럼,

```bash
#!colima/ssh/bin/bash
curl -X GET http://localhost:5000/v2/_catalog
{"repositories":["ohkang94/test"]}
```

이렇게 나옴

### TODO: #1 지금은 사설 레지스트리에 대해서 배울 필요가 없어 보임. P.95~P.108 나중에 확인하기

### 3.3 harbor : (책에 없는 내용)

#### Harbor 인스톨

- Harbor 설치

vx.xx.x는 잘 보고 해라

[harbor 설치 링크](https://github.com/goharbor/harbor/releases) 에서, `harbor-offline-installer-vx.xx.x.tgz`을 받는다.

- OpenPGP key file 등록

```bash
# public Key 등록
gpg --keyserver hkps://keyserver.ubuntu.com --receive-keys 644FF454C0B4115C
# installer 등록
gpg -v --keyserver hkps://keyserver.ubuntu.com --verify harbor-offline-installer-version.tgz.asc
```

- 압축 풀기

```bash
tar xzvf harbor-offline-installer-vx.xx.x.tgz
```

#### HTTPS 인증

- ca.key 생성

```bash
# 루트이니, 루트 디렉토리에 알아서 만드길
openssl genrsa -out ca.key 4096
```

- ca.cert 생성

```bash
openssl req -x509 -new -nodes -sha512 -days 3650 \
 -key ca.key \
 -out ca.crt


You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
```

- harbor.key 생성

Harbor 서버 자신을 위한 키

```bash
openssl genrsa -out harbor.key 4096
```

- OpenSSL 설정 파일 생성

`vim openssl.cnf`

```ini
[ req ]
default_bits       = 4096
prompt             = no
default_md         = sha512
distinguished_name = dn
req_extensions     = req_ext

[ dn ]
C  = KR
ST = Seoul
L  = Seoul
O  = Harbor
OU = Harbor
CN = 10.101.20.32

[ req_ext ]
subjectAltName = @alt_names

[ alt_names ]
IP.1 = 10.101.20.32
```

- csr 생성

```bash
openssl req -new \
 -key harbor.key \
 -out harbor.csr \
 -config openssl.cnf
```

- CA로 서버 인증서 생성

```bash
openssl x509 -req \
 -in harbor.csr \
 -CA ca.crt \
 -CAkey ca.key \
 -CAcreateserial \
 -out harbor.crt \
 -days 3650 \
 -sha512 \
 -extensions req_ext \
 -extfile openssl.cnf
Certificate request self-signature ok
subject=C = KR, ST = Seoul, L = Seoul, O = Harbor, OU = Harbor, CN = 10.101.20.32
```

- 권한 부여

```bash
chmod 644 harbor.key ca.crt harbor.crt
```

#### 실행

- harbor.yml 수정

[harbor.yml](./harbor.yml)
참고

- harbor 폴더 들어가서, 실행 권한주고,
  `./prepare` 실행

```bash
❯ ./prepare;
prepare base dir is set to /home/laonpeople/harbor
Clearing the configuration file: /config/portal/nginx.conf
Clearing the configuration file: /config/registry/passwd
Clearing the configuration file: /config/registry/config.yml
Clearing the configuration file: /config/db/env
Clearing the configuration file: /config/log/logrotate.conf
Clearing the configuration file: /config/log/rsyslog_docker.conf
Clearing the configuration file: /config/registryctl/config.yml
Clearing the configuration file: /config/registryctl/env
Clearing the configuration file: /config/jobservice/config.yml
Clearing the configuration file: /config/jobservice/env
Clearing the configuration file: /config/nginx/nginx.conf
Clearing the configuration file: /config/core/app.conf
Clearing the configuration file: /config/core/env
Generated configuration file: /config/portal/nginx.conf
Generated configuration file: /config/log/logrotate.conf
Generated configuration file: /config/log/rsyslog_docker.conf
Generated configuration file: /config/nginx/nginx.conf
Generated configuration file: /config/core/env
Generated configuration file: /config/core/app.conf
Generated configuration file: /config/registry/config.yml
Generated configuration file: /config/registryctl/env
Generated configuration file: /config/registryctl/config.yml
Generated configuration file: /config/db/env
Generated configuration file: /config/jobservice/env
Generated configuration file: /config/jobservice/config.yml
copy /data/secret/tls/harbor_internal_ca.crt to shared trust ca dir as name harbor_internal_ca.crt ...
ca file /hostfs/data/secret/tls/harbor_internal_ca.crt is not exist
copy  to shared trust ca dir as name storage_ca_bundle.crt ...
copy None to shared trust ca dir as name redis_tls_ca.crt ...
loaded secret from file: /data/secret/keys/secretkey
Generated configuration file: /compose_location/docker-compose.yml
Clean up the input dir
```

- `install.sh` 실행

```bash
sudo sh install.sh
```

#### 인증서 전달
❯ sudo cp /cert/ca.crt /etc/docker/certs.d/10.102.20.32/ca.crt
❯ sudo chmod 644 /etc/docker/certs.d/10.102.20.32/ca.crt

- 클라이언트에도 전달하면 된다 단, 각 쓰이는 context에