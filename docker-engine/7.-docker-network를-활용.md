# 7. Docker Network를 활용

## 1. 연결 끊기,

```bash
docker network disconnect wp-network wordpress
```

이러면 끊긴게 보임

## 2. 연결

```bash
docker network connect wp-network wordpress
```

## 3. docker network 상세 설정

```bash
docker network create --drive=bridge \
--subnet=172.72.0.0/16 \
--ip-range=172.72.0.0/24 \
--gateway=172.72.0.1 \
my_custom_network
```

## 3-1. 세부 옵션 설명

1. --subnet=172.72.0.0/16
   네트워크 대역을 지정 (CIDR 표기법)
   이 경우 172.72.0.0 ~ 172.72.255.255 범위 사용 가능
   총 약 65,536 개의 IP 제공
   도커는 여기서 컨테이너들에게 IP를 자동으로 할당
2. --ip-range=172.72.0.0/24
   컨테이너들에게 실제로 할당될 IP 범위를 제한
   여기서는 172.72.0.0 ~ 172.72.0.255 범위만 사용
   즉, subnet 전체가 아니라, 일부 구간만 컨테이너용으로 할당
3. --gateway=172.72.0.1
   게이트웨이 역할을 할 IP 지정
   호스트에 생성되는 브리지 네트워크 인터페이스가 이 주소를 가짐
   컨테이너들은 이 IP를 통해 외부 네트워크와 통신 가능

## 3-2. 결과 동작 구조

호스트에 가상 브리지 인터페이스가 생성됨

이름: br-<hash>
IP: 172.72.0.1 (게이트웨이)

컨테이너가 네트워크에 붙을 때
172.72.0.0/24 범위 내에서 IP가 자동 할당됨
예: 172.72.0.2, 172.72.0.3, …

- 컨테이너 간 통신

같은 네트워크에 붙은 컨테이너끼리는 내부 IP(172.72.0.x)로 직접 통신 가능

- 외부와 통신

컨테이너가 외부 인터넷으로 나갈 때 → 172.72.0.1 게이트웨이를 통해 NAT 변환
외부에서 컨테이너로 들어오려면 → docker run -p로 호스트 포트 바인딩 필요

## 4. 컨테이너 네트워크

다른 컨테이너와 네트워크 환경 공유하기

```bash
docker run -itd --name network_cntr_1 ubuntu
```

```bash
docker run -itd --name network_cntr_2 \
--net container:network_cntr_1 \
ubuntu
```

```bash
docker exec -it network_cntr_1 ifconfig
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.17.0.3  netmask 255.255.0.0  broadcast 172.17.255.255
        ether e6:38:d2:2c:86:57  txqueuelen 0  (Ethernet)
        RX packets 24371  bytes 70459762 (70.4 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 19217  bytes 1278941 (1.2 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

```bash
docker exec -it network_cntr_2 ifconfig
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.17.0.3  netmask 255.255.0.0  broadcast 172.17.255.255
        ether e6:38:d2:2c:86:57  txqueuelen 0  (Ethernet)
        RX packets 24371  bytes 70459762 (70.4 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 19217  bytes 1278941 (1.2 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

## 5. docker net-alias

net-alias 옵션을 쓰면 특정 호스트 이름으로 컨테이너 여러개로 접근 가능하다.

```bash
# 1,2,3 이렇게 만든다.
docker run -itd --name ntk_as_cntr1 \
--net myBridge \
--net-alias alias1 \
ubuntu-net
```

핑용 컨테이너를 생성 후, 핑을 날리면,

```bash
docker run -it --name network_alias_ping --net myBridge ubuntu-net
```

```bash
                 ┌─────────────────────────────┐
                 │        myBridge             │
                 │  (Bridge Network)           │
                 │                             │
                 │  Docker 내장 DNS:           │
                 │  컨테이너 이름 / net-alias  │
                 │  -> 네트워크 내에서 해석    │
                 │                             │
   ┌─────────────┴─────────────┐
   │                           │
┌──────────────┐        ┌──────────────┐
│ ntk_as_cntr1 │        │ ntk_as_cntr2 │
│--------------│        │--------------│
│ IP: 172.72.0.2│       │ IP: 172.72.0.3│
│ Hostname:     │       │ Hostname:     │
│ ntk_as_cntr1  │       │ ntk_as_cntr2  │
│ Net-alias:    │       │ Net-alias:    │
│ alias1        │       │ alias1        │
└──────────────┘        └──────────────┘
           │                    │
           │ alias1 → DNS 조회  │
           │────────────────────┘
           │
           ▼
┌─────────────────────┐
│ network_alias_ping  │
│-------------------- │
│ IP: 172.72.0.4      │
│ Hostname: ping      │
│ ping alias1 → DNS   │
│   └─> ntk_as_cntr1  │
│   └─> ntk_as_cntr2  │
└─────────────────────┘
```

- 브리지 네트워크(myBridge)

Docker가 자동으로 생성하는 가상 브리지
같은 네트워크에 연결된 컨테이너끼리는 내부 DNS로 서로 이름 해석 가능

- --net-alias

여러 컨테이너에 같은 alias를 지정하면
→ 네트워크 내에서 단일 호스트명(alias1) 으로 접근 가능
DNS 라운드로빈 방식으로 alias1 → ntk_as_cntr1 또는 ntk_as_cntr2 IP 선택

- ping 컨테이너

ping alias1 명령을 실행하면 Docker 내장 DNS가
→ alias1에 매핑된 컨테이너 IP 중 하나를 반환

- 직접 컨테이너에서도 확인가능

```bash
root@c78dad98f9a9:/# dig alias1


;; QUESTION SECTION:
;alias1. IN A

;; ANSWER SECTION:
alias1. 600 IN A 172.19.0.4
alias1. 600 IN A 172.19.0.2
alias1. 600 IN A 172.19.0.3

```

## 6. MacVLan 이용

외부 서버 공유기 한대, 두대의 Linux이용기기가 필요하다.- [Docker 기본 개념 및 사용법](#docker-기본-개념-및-사용법)

## 7. 컨테이너 로깅

### 1.JSON 파일 이용하기

```bash
docker run -d --name maria-test \
-e MYSQL_ROOT_PASSWORD=rootPw \
mariadb
```

```bash
docker logs maria-test
```

result :

```bash
2025-09-13 15:56:07+00:00 [Note] [Entrypoint]: Entrypoint script for MariaDB Server 1:12.0.2+maria~ubu2404 started.
2025-09-13 15:56:07+00:00 [Warn] [Entrypoint]: /sys/fs/cgroup///memory.pressure not writable, functionality unavailable to MariaDB
2025-09-13 15:56:07+00:00 [Note] [Entrypoint]: Switching to dedicated user 'mysql'
2025-09-13 15:56:07+00:00 [Note] [Entrypoint]: Entrypoint script for MariaDB Server 1:12.0.2+maria~ubu2404 started.
2025-09-13 15:56:07+00:00 [Note] [Entrypoint]: Initializing database files
2025-09-13 15:56:07 0 [Warning] mariadbd: io_uring_queue_init() failed with EPERM: sysctl kernel.io_uring_disabled has the value 2, or 1 and the user of the process is not a member of sysctl kernel.io_uring_group. (see man 2 io_uring_setup).
create_uring failed: falling back to libaio
2025-09-13 15:56:08+00:00 [Note] [Entrypoint]: Database files initialized
```

```bash
docker run -it --name logtest ubuntu-net
root@f44348f2474c:/# echo test!!!
bash: !!: event not found
root@f44348f2474c:/# echo "test!!!"
bash: !!: event not found
root@f44348f2474c:/# echo test!
test!
```

```bash
docker logs logtest
root@f44348f2474c:/# echo test!!!
bash: !!: event not found
root@f44348f2474c:/# echo "test!!!"
bash: !!: event not found
root@f44348f2474c:/# echo test!
test!
root@f44348f2474c:/# docker ^C
root@f44348f2474c:/# exit
exit
```

- mac의 경우 colima로 확인해보면,

```bash
root@colima:/var/lib/docker/containers/f44348f2474cf0cf247fa11960996b9783e4e3fb99790c1928733e59e4c76dd8# ls
checkpoints                                                                hostconfig.json  mounts
config.v2.json                                                             hostname         resolv.conf
f44348f2474cf0cf247fa11960996b9783e4e3fb99790c1928733e59e4c76dd8-json.log  hosts            resolv.conf.hash
```

이런식으로 잘 있는것을 확인 가능

### 2. syslog

syslog는 Unix 계열에서 사용하는 로그 수집 표준

```bash
docker run -d \
--name syslog_cntr \
ubuntu-net \
echo sys\nlog\ntest
```

rsyslog 서버 생성

```bash
docker run -itd \
-h rsyslog \
--name rsyslog_server \
-p 514:514 \
-p 514:514/udp \
ubuntu-net
```

client 호스트에서 컨테이너를 생성해, rsyslog컨테이너의 내부 syslog파일을 확인해 로그 전송된거 확인하기

```bash
docker run -itd \
--log-driver=syslog \
--log-opt syslog-address=tcp:192.168.0.100:514 \
--log-opt tag="mylog" \
ubuntu-net
```

## 3. Fluentd[^1] 로깅

### 1. 테스트 환경 조성

도커 서버 2대 : 192.168.0.100
fluent 서버 1대 : 192.168.0.101
mongo : 192.168.0.102
가정

```bash
docker network create \
--driver=bridge \
--subnet=192.168.0.0/24 \
fluentd-net
```

mongo 서버 생성

```bash
docker run -d \
--name mongodb \
--network fluentd-net \
--ip 192.168.0.102 \
-e MONGO_INITDB_ROOT_USERNAME=root \
-e MONGO_INITDB_ROOT_PASSWORD=rootPw \
-p 27017:27017 \
mongo
```

fluent 실행

```bash
# docker-images/fluentd_mongo/
docker run -d --name fluentd \
-p 24224:24224 \
--network fluentd-net \
--ip 192.168.0.101 \
-v $(pwd)/fluent.conf:/fluentd/etc/fluent.conf \
-e FLUENT_CONF=fluent.conf \
fluentd:mongo
```

컨테이너

```bash
docker run -p 80:80 -d \
--network fluentd-net \
--log-driver=fluentd \
--log-opt fluentd-address=192.168.0.101:24224 \
--log-opt tag=docker.nginx.webserver \
nginx
```

그다음 몽고 DB에서 확인
`docker exec -it mongodb mongosh --username root --password rootPw --authenticationDatabase admin`

```mongo
admin> use fluentd
switched to db fluentd
fluentd> show collections
nginx_logs
fluentd> db.nginx_logs.find().pretty()
[
  {
    _id: ObjectId('68c64380a9a51d000cbbe2f4'),
    source: 'stdout',
    log: '/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration',
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe2f5'),
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    source: 'stdout',
    log: '/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe2f6'),
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    source: 'stdout',
    log: '/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe2f7'),
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    source: 'stdout',
    log: '10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe2f8'),
    source: 'stdout',
    log: '10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf',
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe2f9'),
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    source: 'stdout',
    log: '/docker-entrypoint.sh: Sourcing /docker-entrypoint.d/15-local-resolvers.envsh',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe2fa'),
    source: 'stdout',
    log: '/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh',
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe2fb'),
    source: 'stdout',
    log: '/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh',
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe2fc'),
    container_name: '/unruffled_panini',
    source: 'stdout',
    log: '/docker-entrypoint.sh: Configuration complete; ready for start up',
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe2fd'),
    source: 'stderr',
    log: '2025/09/14 04:24:21 [notice] 1#1: using the "epoll" event method',
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe2fe'),
    container_name: '/unruffled_panini',
    source: 'stderr',
    log: '2025/09/14 04:24:21 [notice] 1#1: nginx/1.29.1',
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe2ff'),
    container_name: '/unruffled_panini',
    source: 'stderr',
    log: '2025/09/14 04:24:21 [notice] 1#1: built by gcc 12.2.0 (Debian 12.2.0-14+deb12u1) ',
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe300'),
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    source: 'stderr',
    log: '2025/09/14 04:24:21 [notice] 1#1: OS: Linux 6.8.0-64-generic',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe301'),
    log: '2025/09/14 04:24:21 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576',
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    source: 'stderr',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe302'),
    log: '2025/09/14 04:24:21 [notice] 1#1: start worker processes',
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    source: 'stderr',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe303'),
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    source: 'stderr',
    log: '2025/09/14 04:24:21 [notice] 1#1: start worker process 28',
    time: ISODate('2025-09-14T04:24:21.000Z')
  },
  {
    _id: ObjectId('68c64380a9a51d000cbbe304'),
    source: 'stderr',
    log: '2025/09/14 04:24:21 [notice] 1#1: start worker process 29',
    container_id: 'b6c7b213bfe50b07486b64002d431f8c2c53ae73de7a585f956d1324861f6af7',
    container_name: '/unruffled_panini',
    time: ISODate('2025-09-14T04:24:21.000Z')
  }
]
```

---

[^1]: https://blog.naver.com/brainzsquare/223480126246
