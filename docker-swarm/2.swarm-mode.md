# 2. 도커 스웜 모드

- 도커 스웜 모드는 별도의 설치과정이 필요하지 않다.
- 하지만, 보통 스웜모드의 상태는 비활성으로 설정 되어있다.

**서버 클러스터링을 할때는 각 서버의 시각을 NTP등의 툴을 이용해 동기화 해야한다.**

## 2.1 도커 스웜 구조

- 스웜은 2가지 노드로 구성되어있다.
  - Manager : 워커노드를 관리하기 위한 도커 서버. 하지만, Manager도 컨테이너에도 생성 가능 즉, Worker노드의 역할을 포함
  - Worker : 실제 컨테이너가 생성되고 관리되는 도커 서버
- 매니져 노드는 무조건 1개 이상, 2n-1의 개수를 유지하여야만한다.
  - [Raft Consensus](https://thesecretlivesofdata.com/raft/) 참고. 왜 홀수를 유지하는지 나옴
- 메니져노드도 1개를 사용하는것이 아니라, 운영환경에서는 다중화 하는것이 좋다. 이러면, 매니져의 부하를 분산하고, 특정 매니져가 다운되어도, 스웜을 정상적으로 유지가 가능

## 2.2 도커 스웜 클러스터 구축

- 환경을 아래와 같이 가정

```bash
manager 10.102.20.32
worker1 10.10.110.15
worker2 10.10.20.91
```

### 스웜 시작

- 매니져 역할을 할 서버에 노드에 접근하기 위한 IP주소 입력
  - 필요한 이유는 내가 어떤 Network Interface Card로 접근할 지 알아야 하기 때문에
  - 2377, 7946/tcp, 7946/udp, 4789/udp, 4789/tcp 이렇게 다 열어야한다. 포트는 꼭

```bash
docker swarm init --advertise-addr 10.102.20.32
Swarm initialized: current node (gr9hx828svz91anfynghcb1bc) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-68oev8kt07ycxy45r54o7ilttvkzjgzmhnziamvgbzz02486rz-14ac1drnfc1qv5wugt8g90635 10.102.20.32:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
```

### 워커 노드 추가

```bash
docker swarm join --token SWMTKN-1-68oev8kt07ycxy45r54o7ilttvkzjgzmhnziamvgbzz02486rz-14ac1drnfc1qv5wugt8g90635 10.102.20.32:2377
```

### 도커 노드 확인

```bash
❯ docker node ls
ID                            HOSTNAME                STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
jot0fw3jxcaqu6istj8d2l5qk     baroserver66-ubuntu18   Ready     Active                          24.0.2
bo5kl3l26mubrik6czb4i3l5e     colima                  Ready     Active                          28.3.3
pthddquqfyyf4f9kp41domb5c *   lp-pc-2023-026          Ready     Active         Leader           27.3.1
```

### 토큰 재확인

```bash
❯ docker swarm join-token manager
To add a manager to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-3elpsd1g835jgt42q48w936m2ecblnjwjao1oi7vfl2atccwgk-8tj72nh2djxy0fjw243e2i1fw 10.102.20.32:2377
```

### 토큰 갱신

```bash
❯ docker swarm join-token --rotate manager
Successfully rotated manager join token.

To add a manager to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-3elpsd1g835jgt42q48w936m2ecblnjwjao1oi7vfl2atccwgk-7e26egmumj2tsyczinvx8uka9 10.102.20.32:2377
```

### 노드 나가기

```bash
❯ docker swarm leave
Node left the swarm.
```

이렇게 되는데,
문제는 그대로 노드에 남는다 메니져에서는

```bash
❯ docker node ls
ID                            HOSTNAME                STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
jot0fw3jxcaqu6istj8d2l5qk     baroserver66-ubuntu18   Ready     Active                          24.0.2
bo5kl3l26mubrik6czb4i3l5e     colima                  Down      Active                          28.3.3
pthddquqfyyf4f9kp41domb5c *   lp-pc-2023-026          Ready     Active         Leader           27.3.1
```

그래서,

```bash
❯ docker node rm colima
colima
```

이런식으로 직접 노드를 삭제해야여만 한다.
매니져노드는

```bash
docker swarm leave --force
```

이렇게 메니져노드를 지울 수있다.

### 워커 <-> 메니져 스왑

메니져 승진 시킬때

```bash
❯ docker node promote colima
Node colima promoted to a manager in the swarm.
```

메니져 에서 내릴때

```bash
❯ docker node demote baroserver66-ubuntu18
Manager baroserver66-ubuntu18 demoted in the swarm.
```
